name: Cleanup Workflow Runs
on:
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥0ç‚¹è¿è¡Œ
  workflow_dispatch:
    inputs:
      keep_days:
        description: "ä¿ç•™æœ€è¿‘å¤šå°‘å¤©ï¼ˆ0=å…¨éƒ¨æ¸…ç†ï¼Œé»˜è®¤0ï¼‰"
        required: false
        default: "0"
      repository:
        description: "è¦æ¸…ç†çš„ä»“åº“ï¼ˆæ ¼å¼ï¼šowner/repoï¼Œç•™ç©ºä¸ºå½“å‰ä»“åº“ï¼‰"
        required: false
        default: ""
      exclude_current:
        description: "æ’é™¤æ­£åœ¨è¿è¡Œçš„å·¥ä½œæµ"
        required: false
        default: "true"

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: è®¾ç½®ç›®æ ‡ä»“åº“
        id: set-repo
        run: |
          if [ -z "${{ github.event.inputs.repository }}" ]; then
            echo "repository=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "ğŸ” å°†æ¸…ç†å½“å‰ä»“åº“ï¼š${{ github.repository }}"
          else
            echo "repository=${{ github.event.inputs.repository }}" >> $GITHUB_OUTPUT
            echo "ğŸ” å°†æ¸…ç†æŒ‡å®šä»“åº“ï¼š${{ github.event.inputs.repository }}"
          fi
      
      - name: æ¸…ç†å·¥ä½œæµè¿è¡Œ
        env:
          KEEP_DAYS: ${{ github.event.inputs.keep_days }}
          EXCLUDE_CURRENT: ${{ github.event.inputs.exclude_current }}
          TARGET_REPO: ${{ steps.set-repo.outputs.repository }}
        run: |
          # è®¾ç½®é»˜è®¤å€¼
          : "${KEEP_DAYS:=0}"
          : "${EXCLUDE_CURRENT:=true}"
          
          echo "ğŸ”§ å‚æ•°é…ç½®ï¼š"
          echo "  - ä¿ç•™å¤©æ•°: $KEEP_DAYS (0=å…¨éƒ¨æ¸…ç†)"
          echo "  - æ’é™¤å½“å‰è¿è¡Œ: $EXCLUDE_CURRENT"
          echo "  - ç›®æ ‡ä»“åº“: $TARGET_REPO"
          
          # æ„å»ºåŸºç¡€æŸ¥è¯¢æ¡ä»¶ï¼ˆåªæ¸…ç†å·²å®Œæˆçš„å·¥ä½œæµï¼‰
          JQ_FILTER='.workflow_runs[] | select(.status=="completed")'
          
          # æ’é™¤å½“å‰è¿è¡Œï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if [ "$EXCLUDE_CURRENT" = "true" ] && [ "$TARGET_REPO" = "${{ github.repository }}" ]; then
            JQ_FILTER="$JQ_FILTER | select(.id != ${{ github.run_id }})"
            echo "âš ï¸ å·²æ’é™¤å½“å‰è¿è¡Œçš„å·¥ä½œæµï¼ˆID: ${{ github.run_id }}ï¼‰"
          fi
          
          # å¦‚æœè®¾ç½®äº†ä¿ç•™å¤©æ•°ï¼Œæ·»åŠ æ—¶é—´ç­›é€‰
          if [ "$KEEP_DAYS" -gt 0 ]; then
            THRESHOLD=$(date -u -d "${KEEP_DAYS} days ago" '+%Y-%m-%dT%H:%M:%SZ')
            echo "ğŸ“… ä¿ç•™æœ€è¿‘ $KEEP_DAYS å¤©çš„è¿è¡Œè®°å½•"
            echo "â° é˜ˆå€¼æ—¶é—´(UTC)ï¼š$THRESHOLD"
            JQ_FILTER="$JQ_FILTER | select(.created_at < \"$THRESHOLD\")"
          else
            echo "âš ï¸ è­¦å‘Šï¼šå°†æ¸…ç†æ‰€æœ‰å·²å®Œæˆçš„å·¥ä½œæµè¿è¡Œ"
            echo "âš ï¸ æ³¨æ„ï¼šåªä¼šåˆ é™¤çŠ¶æ€ä¸º 'completed' çš„è¿è¡Œ"
          fi
          
          echo "ğŸ¯ ç›®æ ‡ä»“åº“ï¼š$TARGET_REPO"
          echo "ğŸ” å¼€å§‹è·å–å¾…æ¸…ç†çš„è¿è¡Œ..."
          
          # åˆå§‹åŒ–è®¡æ•°å˜é‡
          TOTAL_DELETED=0
          TOTAL_FAILED=0
          page=1
          
          # ä¸»å¾ªç¯
          while true; do
            echo "ğŸ“„ æ­£åœ¨è·å–ç¬¬ $page é¡µ..."
            
            # ä½¿ç”¨ GitHub API è·å–å·¥ä½œæµè¿è¡Œ
            RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.AUTH_PAT }}" \
                          -H "Accept: application/vnd.github.v3+json" \
                          "https://api.github.com/repos/$TARGET_REPO/actions/runs?per_page=100&page=$page")
            
            # æ£€æŸ¥å“åº”æ˜¯å¦æœ‰æ•ˆ
            if ! echo "$RESPONSE" | jq -e '.workflow_runs' > /dev/null 2>&1; then
              echo "âŒ API å“åº”å¼‚å¸¸ï¼Œå¯èƒ½ä»“åº“ä¸å­˜åœ¨æˆ–æ— æƒé™"
              echo "å“åº”å†…å®¹ï¼š"
              echo "$RESPONSE" | head -100
              break
            fi
            
            # è·å–å½“å‰é¡µçš„è¿è¡ŒID
            RUN_IDS=$(echo "$RESPONSE" | jq -r "$JQ_FILTER | .id" | tr '\n' ' ')
            
            # å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šé¡µ
            if [ -z "$RUN_IDS" ] || [ "$RUN_IDS" = " " ]; then
              echo "âœ… ç¬¬ $page é¡µæ²¡æœ‰å¯åˆ é™¤çš„è¿è¡Œ"
              TOTAL_COUNT=$(echo "$RESPONSE" | jq '.total_count // 0')
              TOTAL_PROCESSED=$(( (page-1) * 100 ))
              if [ $TOTAL_PROCESSED -ge $TOTAL_COUNT ]; then
                echo "ğŸ“Š å·²å¤„ç†å®Œæ‰€æœ‰ $TOTAL_COUNT ä¸ªè®°å½•"
                break
              fi
            else
              # æ¸…ç†RUN_IDSï¼ˆå»é™¤å¤šä½™ç©ºæ ¼ï¼‰
              RUN_IDS=$(echo "$RUN_IDS" | xargs)
              COUNT=$(echo "$RUN_IDS" | wc -w)
              echo "ğŸ—‘ï¸ ç¬¬ $page é¡µå‘ç° $COUNT ä¸ªå¾…åˆ é™¤è¿è¡Œ"
              
              # å®‰å…¨ç¡®è®¤ï¼ˆä»…åœ¨æ‰‹åŠ¨è§¦å‘ä¸”æ•°é‡å¤§æ—¶ï¼‰
              if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "$page" -eq 1 ] && [ "$COUNT" -gt 50 ]; then
                echo "â¸ï¸  å‘ç°è¶…è¿‡50ä¸ªè¿è¡Œï¼Œæš‚åœ5ç§’..."
                sleep 5
              fi
              
              # åˆ é™¤å½“å‰é¡µçš„è¿è¡Œ
              DELETED_THIS_PAGE=0
              FAILED_THIS_PAGE=0
              
              for RUN_ID in $RUN_IDS; do
                echo "  æ­£åœ¨åˆ é™¤è¿è¡Œ ID: $RUN_ID"
                
                DELETE_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
                  -H "Authorization: token ${{ secrets.AUTH_PAT }}" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/$TARGET_REPO/actions/runs/$RUN_ID")
                
                # æ£€æŸ¥åˆ é™¤æ˜¯å¦æˆåŠŸï¼ˆ204 No Content è¡¨ç¤ºæˆåŠŸï¼‰
                if [ "$DELETE_RESPONSE" = "204" ]; then
                  echo "    âœ… åˆ é™¤æˆåŠŸ"
                  DELETED_THIS_PAGE=$((DELETED_THIS_PAGE + 1))
                else
                  echo "    âŒ åˆ é™¤å¤±è´¥ (HTTP $DELETE_RESPONSE)"
                  FAILED_THIS_PAGE=$((FAILED_THIS_PAGE + 1))
                fi
                
                # æ·»åŠ å»¶è¿Ÿé¿å…é€Ÿç‡é™åˆ¶
                sleep 0.3
              done
              
              TOTAL_DELETED=$((TOTAL_DELETED + DELETED_THIS_PAGE))
              TOTAL_FAILED=$((TOTAL_FAILED + FAILED_THIS_PAGE))
              
              echo "ğŸ“Š ç¬¬ $page é¡µå®Œæˆï¼šæˆåŠŸ $DELETED_THIS_PAGEï¼Œå¤±è´¥ $FAILED_THIS_PAGE"
            fi
            
            # ç»§ç»­ä¸‹ä¸€é¡µ
            page=$((page + 1))
          done
          
          echo "ğŸ‰ æ¸…ç†å®Œæˆï¼"
          echo "ğŸ“ˆ æ€»è®¡ï¼šæˆåŠŸåˆ é™¤ $TOTAL_DELETED ä¸ªè¿è¡Œï¼Œå¤±è´¥ $TOTAL_FAILED ä¸ª"
          
          # å¦‚æœå…¨éƒ¨å¤±è´¥ä¸”å°è¯•äº†åˆ é™¤ï¼Œå¯èƒ½æƒé™æœ‰é—®é¢˜
          if [ $TOTAL_DELETED -eq 0 ] && [ $TOTAL_FAILED -gt 0 ]; then
            echo "âŒ æ‰€æœ‰åˆ é™¤éƒ½å¤±è´¥äº†ï¼è¯·æ£€æŸ¥ï¼š"
            echo "   1. AUTH_PAT æ˜¯å¦æœ‰è¶³å¤Ÿæƒé™ï¼ˆéœ€è¦ repo æƒé™ï¼‰"
            echo "   2. ä»“åº“åç§°æ˜¯å¦æ­£ç¡®"
            echo "   3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
            echo "   4. æ£€æŸ¥ PAT æ˜¯å¦è¿‡æœŸ"
            exit 1
          fi
          
          # å¦‚æœæ²¡æœ‰ä»»ä½•æ“ä½œ
          if [ $TOTAL_DELETED -eq 0 ] && [ $TOTAL_FAILED -eq 0 ]; then
            echo "âœ… æ²¡æœ‰éœ€è¦æ¸…ç†çš„è¿è¡Œ"
          fi
      
      - name: ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ“‹ æ¸…ç†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**ç›®æ ‡ä»“åº“**: ${{ steps.set-repo.outputs.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**ä¿ç•™å¤©æ•°**: ${{ github.event.inputs.keep_days || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ’é™¤å½“å‰è¿è¡Œ**: ${{ github.event.inputs.exclude_current || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… å·¥ä½œæµå·²æ‰§è¡Œå®Œæˆ" >> $GITHUB_STEP_SUMMARY
