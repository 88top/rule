name: Sync Fork from Upstream

on:
  schedule:
    # 每天北京时间 03:00 和 15:00 自动运行（UTC 时间转换）
    - cron: '0 19 * * *'  # UTC 19:00 = 北京时间 次日 03:00
    - cron: '0 7 * * *'   # UTC 07:00 = 北京时间 当天 15:00
  workflow_dispatch:
    inputs:
      upstream_repos:
        description: |
          要同步的源仓库 (格式: owner/repo)
          多个用逗号分隔，留空为当前仓库
          输入 'all' 使用默认配置
        required: false
        default: 'all'
      force_sync:
        description: '强制同步（忽略时间检查）'
        type: boolean
        default: false

# 授予工作流必要的权限，用于推送代码到仓库
permissions:
  contents: write
  pull-requests: read

jobs:
  sync-fork-branches:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出当前 Fork 仓库的代码
      - name: Checkout current fork repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 完整检出所有历史和分支，必须配置否则无法同步多分支

      # 步骤2：配置 Git 身份（用于提交同步记录）
      - name: Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 步骤3：定义默认上游仓库（核心配置：你的源仓库）
      - name: Set default upstream repositories (all)
        id: set-upstream
        run: |
          # 配置默认上游仓库（替换为你的目标源仓库，多个用逗号分隔）
          DEFAULT_UPSTREAM="timeflysoon/OpenClash"
          
          # 获取手动输入的 upstream_repos 参数
          INPUT_UPSTREAM="${{ github.event.inputs.upstream_repos }}"
          
          # 处理参数逻辑：all -> 使用默认仓库，留空 -> 当前仓库，否则使用输入值
          if [[ "$INPUT_UPSTREAM" == "all" ]]; then
            UPSTREAM_REPOS="$DEFAULT_UPSTREAM"
          elif [[ -z "$INPUT_UPSTREAM" ]]; then
            UPSTREAM_REPOS="${{ github.repository }}"
          else
            UPSTREAM_REPOS="$INPUT_UPSTREAM"
          fi
          
          # 输出到环境变量，供后续步骤使用
          echo "UPSTREAM_REPOS=$UPSTREAM_REPOS" >> $GITHUB_ENV

      # 步骤4：循环同步每个上游仓库的所有分支（已修复 fetch 命令）
      - name: Sync all branches from upstream repositories
        run: |
          # 分割上游仓库列表（逗号分隔）
          IFS=',' read -ra UPSTREAM_LIST <<< "$UPSTREAM_REPOS"
          
          for UPSTREAM in "${UPSTREAM_LIST[@]}"; do
            # 去除仓库名前后空格（防止输入格式错误）
            UPSTREAM=$(echo "$UPSTREAM" | xargs)
            echo "======================================"
            echo "Starting to sync from upstream: $UPSTREAM"
            echo "======================================"
            
            # 1. 添加上游仓库远程地址（如果已存在则更新）
            UPSTREAM_REMOTE="upstream-$UPSTREAM"
            if git remote | grep -q "$UPSTREAM_REMOTE"; then
              git remote set-url "$UPSTREAM_REMOTE" "https://github.com/$UPSTREAM.git"
            else
              git remote add "$UPSTREAM_REMOTE" "https://github.com/$UPSTREAM.git"
            fi
            
            # 2. 从指定上游仓库拉取所有分支和标签（修复：移除 --all 参数，仅拉取当前远程仓库）
            git fetch "$UPSTREAM_REMOTE" --tags --prune  # 关键修复：删除 --all，语法正确
            
            # 3. 获取上游仓库的所有分支列表（排除 HEAD 和远程默认分支）
            UPSTREAM_BRANCHES=$(git branch -r | grep "$UPSTREAM_REMOTE/" | grep -v HEAD | sed "s|$UPSTREAM_REMOTE/||g")
            
            # 4. 循环同步每个分支
            for BRANCH in $UPSTREAM_BRANCHES; do
              echo "--------------------------------------"
              echo "Syncing branch: $BRANCH"
              echo "--------------------------------------"
              
              # a. 切换到该分支（如果本地不存在则创建）
              if git rev-parse --verify "$BRANCH" >/dev/null 2>&1; then
                git checkout "$BRANCH"
              else
                git checkout -b "$BRANCH" "$UPSTREAM_REMOTE/$BRANCH"
              fi
              
              # b. 合并上游分支（如果需要强制同步，使用 reset 替代 merge）
              if [[ "${{ github.event.inputs.force_sync }}" == "true" ]]; then
                git reset --hard "$UPSTREAM_REMOTE/$BRANCH"
                echo "Force synced branch $BRANCH with upstream (reset --hard)"
              else
                git merge --ff-only "$UPSTREAM_REMOTE/$BRANCH"
                echo "Fast-forward merged branch $BRANCH with upstream"
              fi
              
              # c. 推送同步后的分支到当前 Fork 仓库（强制推送仅在手动开启 force_sync 时使用）
              if [[ "${{ github.event.inputs.force_sync }}" == "true" ]]; then
                git push origin "$BRANCH" --force
              else
                git push origin "$BRANCH"
              fi
            done
          done
          
          echo "======================================"
          echo "All branches sync completed successfully!"
          echo "======================================"
