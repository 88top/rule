name: Sync Fork from Upstream

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      sources:
        description: "æºä»“åº“åˆ—è¡¨ï¼ˆowner/repoï¼Œé€—å·åˆ†éš”ï¼›ç•™ç©º=å½“å‰ä»“åº“æºä»“åº“ï¼›è¾“å…¥ 'all'=æ‰€æœ‰forkæºä»“åº“ï¼‰"
        required: false
        default: ""
  schedule:
    - cron: '30 * * * *'  # æ¯å°æ—¶çš„ç¬¬30åˆ†é’Ÿè¿è¡Œï¼ˆå³æºä»“åº“æ›´æ–°åçº¦åŠå°æ—¶ï¼‰

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: ç”Ÿæˆ Tokenï¼ˆé˜²æ—¥å¿—æ³„éœ²ï¼‰
        id: gen-token
        run: echo "token=${{ secrets.SYNC_PAT }}" >> $GITHUB_OUTPUT

      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.gen-token.outputs.token }}

      - name: è®¾ç½® Git é…ç½®
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: è·å–æºä»“åº“åˆ—è¡¨
        id: get-sources
        env:
          GH_TOKEN: ${{ steps.gen-token.outputs.token }}
        run: |
          INPUT="${{ inputs.sources }}"
          
          if [[ "$INPUT" == "all" ]]; then
            echo "è·å–æ‰€æœ‰ fork çš„æºä»“åº“..."
            SOURCES=$(gh api "/repos/${{ github.repository }}/forks" --paginate -q '.[].parent.full_name' | sort -u | paste -sd "," -)
          elif [[ -z "$INPUT" ]]; then
            echo "ä½¿ç”¨å½“å‰ä»“åº“çš„æºä»“åº“..."
            SOURCES=$(gh api "/repos/${{ github.repository }}" -q '.parent.full_name // empty')
          else
            SOURCES=$(echo "$INPUT" | sed 's/ //g' | tr ',' '\n' | sort -u | paste -sd "," -)
          fi
          
          if [[ -z "$SOURCES" ]]; then
            echo "æœªæ‰¾åˆ°æºä»“åº“ï¼Œé€€å‡º"
            exit 0
          fi
          
          echo "sources=$SOURCES" >> $GITHUB_OUTPUT
          echo "å°†åŒæ­¥æºä»“åº“ï¼š$SOURCES"

      - name: åŒæ­¥æ‰€æœ‰æºä»“åº“çš„æ‰€æœ‰åˆ†æ”¯å’Œæ ‡ç­¾
        env:
          GH_TOKEN: ${{ steps.gen-token.outputs.token }}
        run: |
          IFS=',' read -ra SOURCE_ARRAY <<< "${{ steps.get-sources.outputs.sources }}"
          
          for SOURCE in "${SOURCE_ARRAY[@]}"; do
            echo ""
            echo "============================================"
            echo "æ­£åœ¨ä» $SOURCE åŒæ­¥åˆ° ${{ github.repository }}"
            echo "============================================"
            
            # æ·»åŠ æˆ–æ›´æ–° upstream remote
            if git remote get-url upstream >/dev/null 2>&1; then
              git remote set-url upstream "https://x-access-token:$GH_TOKEN@github.com/$SOURCE.git"
            else
              git remote add upstream "https://x-access-token:$GH_TOKEN@github.com/$SOURCE.git"
            fi
            
            # è·å–ä¸Šæ¸¸æ‰€æœ‰æ›´æ–°
            git fetch upstream --tags --prune --prune-tags --force
            
            # è·å–æ‰€æœ‰ä¸Šæ¸¸åˆ†æ”¯
            UPSTREAM_BRANCHES=$(git for-each-ref --format='%(refname:short)' refs/remotes/upstream/ | sed 's|^upstream/||')
            
            UPDATED=0
            for BRANCH in $UPSTREAM_BRANCHES; do
              if git show-ref --quiet --heads "$BRANCH"; then
                # æœ¬åœ°å·²æœ‰åˆ†æ”¯ï¼Œå¼ºåˆ¶æ›´æ–°
                git push origin "upstream/$BRANCH:refs/heads/$BRANCH" --force
                ((UPDATED++))
              else
                # æ–°åˆ†æ”¯ï¼Œç›´æ¥æ¨é€
                git push origin "upstream/$BRANCH:refs/heads/$BRANCH"
                ((UPDATED++))
              fi
            done
            
            # åŒæ­¥æ‰€æœ‰æ ‡ç­¾
            git push origin --tags --force
            
            echo "âœ… å®ŒæˆåŒæ­¥ï¼Œæ›´æ–° $UPDATED ä¸ªåˆ†æ”¯"
          done
          
          echo ""
          echo "ğŸ‰ æ‰€æœ‰æºä»“åº“åŒæ­¥å®Œæˆï¼"
