name: 自动转换 list → mrs

on:
  push:
    paths:
      - 'cn_domain-extra.list'
      - 'proxy-extra.list'
  workflow_dispatch:
    inputs:
      target:
        description: '选择要转换哪个'
        required: true
        type: choice
        default: both
        options:
          - both      # 两个都转（默认）
          - cn_domain-extra   # 只转国内直连
          - proxy-extra       # 只转代理规则

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 确保能拿到历史 hash 文件

      - name: 下载 Clash Meta 内核（永不404）
        run: |
          URL="https://github.com/MetaCubeX/mihomo/releases/download/v1.19.17/mihomo-linux-amd64-v1.19.17.gz"
          wget -q "$URL" || wget -q "https://github.com/MetaCubeX/mihomo/releases/download/v1.19.17/mihomo-linux-amd64-compatible-v1.19.17.gz"
          FILENAME=$(ls *.gz)
          gzip -d "$FILENAME"
          chmod +x "${FILENAME%.gz}"
          mv "${FILENAME%.gz}" clash_meta

      # ============ 生成 cn_domain-extra.mrs ============
      - name: 生成 cn_domain-extra.mrs
        if: inputs.target == 'both' || inputs.target == 'cn_domain-extra'
        run: |
          if [ -f cn_domain-extra.list ]; then
            echo "开始转换 cn_domain-extra.list → cn_domain-extra.mrs"
            ./clash_meta convert-ruleset domain text cn_domain-extra.list cn_domain-extra.mrs
            echo "cn_domain-extra.mrs 生成完成"
          else
            echo "cn_domain-extra.list 不存在，跳过生成"
          fi

      # ============ 生成 proxy-extra.mrs ============
      - name: 生成 proxy-extra.mrs
        if: inputs.target == 'both' || inputs.target == 'proxy-extra'
        run: |
          if [ -f proxy-extra.list ]; then
            echo "开始转换 proxy-extra.list → proxy-extra.mrs"
            ./clash_meta convert-ruleset domain text proxy-extra.list proxy-extra.mrs
            echo "proxy-extra.mrs 生成完成"
          else
            echo "proxy-extra.list 不存在，跳过生成"
          fi

      # ============ 智能提交：只有真正变化才 push ============
      - name: 智能提交（仅当 mrs 内容变化时才真正推送）
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M")
          TARGET="${{ inputs.target }}"

          CHANGED=0   # 是否有实质内容变化

          # 检查 cn_domain-extra.mrs
          if [ -f cn_domain-extra.mrs ]; then
            NEW_HASH=$(sha256sum cn_domain-extra.mrs | cut -d' ' -f1)
            HASH_FILE=".git/cn_domain-extra.mrs.hash"

            if [ -f "$HASH_FILE" ]; then
              OLD_HASH=$(cat "$HASH_FILE")
              if [ "$OLD_HASH" != "$NEW_HASH" ]; then
                echo "cn_domain-extra.mrs 内容已更新"
                CHANGED=1
              else
                echo "cn_domain-extra.mrs 内容无变化"
              fi
            else
              echo "首次生成 cn_domain-extra.mrs"
              CHANGED=1
            fi

            echo "$NEW_HASH" > "$HASH_FILE"
            git add cn_domain-extra.mrs
          fi

          # 检查 proxy-extra.mrs
          if [ -f proxy-extra.mrs ]; then
            NEW_HASH=$(sha256sum proxy-extra.mrs | cut -d' ' -f1)
            HASH_FILE=".git/proxy-extra.mrs.hash"

            if [ -f "$HASH_FILE" ]; then
              OLD_HASH=$(cat "$HASH_FILE")
              if [ "$OLD_HASH" != "$NEW_HASH" ]; then
                echo "proxy-extra.mrs 内容已更新"
                CHANGED=1
              else
                echo "proxy-extra.mrs 内容无变化"
              fi
            else
              echo "首次生成 proxy-extra.mrs"
              CHANGED=1
            fi

            echo "$NEW_HASH" > "$HASH_FILE"
            git add proxy-extra.mrs
          fi

          # 总是更新心跳文件（仅用于本地记录）
          echo "{\"last_run\": \"$TIMESTAMP\", \"target\": \"$TARGET\"}" > last-run.json
          git add last-run.json

          # 只有真正有变化才 commit + push
          if [ $CHANGED -eq 1 ]; then
            git commit -m "chore: update ruleset(s) $TIMESTAMP (target: $TARGET)"
            git push origin main
            echo "检测到规则内容变更，已提交并推送"
          else
            git commit -m "chore: workflow heartbeat $TIMESTAMP (no change, target: $TARGET)" || true
            echo "无实质内容变化，仅记录本地心跳（未推送）"
            echo "仓库保持安静，完美！"
          fi
